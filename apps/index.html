<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <!-- Boxiocns CDN Link -->
    <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
    <title>File Upload</title>
</head>
<body>
    <!-- SideBar -->
    <div class="sidebar close">
        <div class="logo-details">
          <!-- <i class='bx bxl-c-plus-plus'></i> -->
            <center>
                <span class="logo_name">Uploader</span>
            </center>
        </div>
        <ul class="nav-links">
          <!-- <li>
            <a href="#">
              <i class='bx bx-grid-alt' ></i>
              <span class="link_name">Dashboard</span>
            </a> -->
            <!-- <ul class="sub-menu blank">
              <li><a class="link_name" href="#">Category</a></li>
            </ul>
          </li>
          <li>
            <div class="iocn-link">
              <a href="#">
                <i class='bx bx-collection' ></i>
                <span class="link_name">Category</span>
              </a>
              <i class='bx bxs-chevron-down arrow' ></i>
            </div>
            <ul class="sub-menu">
              <li><a class="link_name" href="#">Category</a></li>
              <li><a href="#">HTML & CSS</a></li>
              <li><a href="#">JavaScript</a></li>
              <li><a href="#">PHP & MySQL</a></li>
            </ul>
          </li>
          <li>
            <div class="iocn-link">
              <a href="#">
                <i class='bx bx-book-alt' ></i>
                <span class="link_name">Posts</span>
              </a>
              <i class='bx bxs-chevron-down arrow' ></i>
            </div>
            <ul class="sub-menu">
              <li><a class="link_name" href="#">Posts</a></li>
              <li><a href="#">Web Design</a></li>
              <li><a href="#">Login Form</a></li>
              <li><a href="#">Card Design</a></li>
            </ul>
          </li>
          <li>
            <a href="#">
              <i class='bx bx-pie-chart-alt-2' ></i>
              <span class="link_name">Analytics</span>
            </a>
            <ul class="sub-menu blank">
              <li><a class="link_name" href="#">Analytics</a></li>
            </ul>
          </li>
          <li>
            <a href="#">
              <i class='bx bx-line-chart' ></i>
              <span class="link_name">Chart</span>
            </a>
            <ul class="sub-menu blank">
              <li><a class="link_name" href="#">Chart</a></li>
            </ul>
          </li>
          <li>
            <div class="iocn-link">
              <a href="#">
                <i class='bx bx-plug' ></i>
                <span class="link_name">Plugins</span>
              </a>
              <i class='bx bxs-chevron-down arrow' ></i>
            </div>
            <ul class="sub-menu">
              <li><a class="link_name" href="#">Plugins</a></li>
              <li><a href="#">UI Face</a></li>
              <li><a href="#">Pigments</a></li>
              <li><a href="#">Box Icons</a></li>
            </ul>
          </li>
          <li>
            <a href="#">
              <i class='bx bx-compass' ></i>
              <span class="link_name">Explore</span>
            </a>
            <ul class="sub-menu blank">
              <li><a class="link_name" href="#">Explore</a></li>
            </ul>
          </li>
          <li>
            <a href="#">
              <i class='bx bx-history'></i>
              <span class="link_name">History</span>
            </a>
            <ul class="sub-menu blank">
              <li><a class="link_name" href="#">History</a></li>
            </ul>
          </li>
          <li>
            <a href="#">
              <i class='bx bx-cog' ></i>
              <span class="link_name">Setting</span>
            </a>
            <ul class="sub-menu blank">
              <li><a class="link_name" href="#">Setting</a></li>
            </ul>
          </li>
          <li> -->
        <div class="profile-details">
          <div class="profile-content">
            <img src="images/profile.jpg" alt="profileImg">
          </div>
          <div class="name-job">
            <div class="profile_name">Álvaro Bienvenido</div>
            <div class="job">Software Engineer</div>
          </div>
          <!-- <i class='bx bx-log-out' ></i> -->
        </div>
      </li>
    </ul>
    </div>
    <!-- Section -->
    <section class="home-section">
        <div class="home-content">
          <i class='bx bx-menu' ></i>
          <!-- <span class="text">Drop Down Sidebar</span> -->
        </div>

        <!-- Uploader -->
        <!-- <h2>File Upload</h2> -->
        <!-- <form id="uploadForm" enctype="multipart/form-data">
            <input type="file" id="fileInput" name="file_bg_pic">
            <button type="button" id="uploadButton" onclick="uploadFile()">Upload</button>
        </form> -->
        <!-- <progress id="progressBar" value="0" max="100"></progress> -->
        <!-- <div id="status"></div> -->

        <!-- Uploader 2 -->
        <center>
            <div class="container">
                <div id="status"></div>
                <div class="drag-area" id="dragArea">
                    <img src="images/icon-folder-blue.png" alt="Imagen" class="upload-icon">
                    <header>
                        Drop your file here
                    </header>
                    <div class="linea"><span>OR</span></div>
                    <label class="custom-file-upload">
                        <input type="file" id="fileInput2" name="file_bg_pic2">
                        Browse File
                    </label>
                </div>
                <div id="fileInfoDiv">
                    <!-- Aquí se mostrará la información del archivo -->
                </div>
                <!-- Botones alineados horizontalmente -->
                <div class="buttons-container">
                    <button type="button" class="reload-button" onclick="location.reload()">Reload</button>
                    <button type="button" id="uploadButton" onclick="uploadFile()">Upload</button>
                </div>
            </div>
        </center>

    </section>

    <script src="script.js"></script>

    <!-- Refresh progressbar  -->
    <!-- <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Obtener referencia al input de tipo archivo
            const fileInput2 = document.getElementById('fileInput2');
            // Obtener referencia al botón de carga
            const uploadButton = document.getElementById('uploadButton');
            // Obtener referencia a la barra de progreso
            const progressBar = document.getElementById('progressBar');

            // Escuchar el evento de clic en el botón fileInput2
            fileInput2.addEventListener('click', function() {
                // Restablecer la barra de progreso a 0
                progressBar.value = 0;
                // Habilitar el botón de carga
                uploadButton.disabled = false;
            });
        });
    </script> -->

    <!-- Evento button uploader -->
    <script>
        // Obtener referencia al input de tipo archivo
        const fileInput = document.getElementById('fileInput2');

        // Obtener referencia al div donde se mostrará la información del archivo
        const fileInfoDiv = document.getElementById('fileInfoDiv');

        // Escuchar el evento de cambio en el input de tipo archivo
        fileInput.addEventListener('change', function() {
            // Verificar si se seleccionó un archivo
            if (this.files.length > 0) {
                // Obtener el nombre del archivo
                const fileName = this.files[0].name;
                // Obtener el tamaño del archivo en MB
                const fileSize = (this.files[0].size / (1024 * 1024)).toFixed(2); // Convertir a MB con dos decimales
                // Crear el contenido HTML para mostrar la información del archivo
                const fileInfoHTML = `
                    <div class='nameFile'>${fileName}</div>
                    <div>${fileSize} MB</div>
                    <progress id="progressBar" max="100" value="0"></progress>
                    <span id="progressValue">0%</span>
                `;
                // Asignar el contenido HTML al div de información del archivo
                fileInfoDiv.innerHTML = fileInfoHTML;
                // Mostrar el div de información del archivo
                fileInfoDiv.style.display = 'block';

                const uploadButton = document.getElementById('uploadButton');

                uploadButton.style.display = 'block'; // Mostrar el botón uploadButton

                // Eliminamos la clase para que esté de nuevo habilitadop
                document.getElementById('uploadButton').classList.remove('disabled');
                
            } else {
                // Si no se seleccionó ningún archivo, limpiar el contenido del div
                fileInfoDiv.innerHTML = '';
                // Ocultar el div de información del archivo
                fileInfoDiv.style.display = 'none';
                uploadButton.style.display = 'none'; // Ocultar el botón uploadButton
            }
        });

    </script>

    <!-- Evento Drag And Drop -->
    <script>
        // Obtener referencia al área de arrastrar y soltar
        const dragArea = document.getElementById('dragArea');

        // Escuchar el evento de arrastrar sobre el área
        dragArea.addEventListener('dragover', function(event) {
            event.preventDefault(); // Evitar el comportamiento predeterminado del navegador
            dragArea.classList.add('dragging'); // Añadir clase "dragging" para resaltar el área de arrastrar y soltar
        });

        // Escuchar el evento de soltar en el área
        dragArea.addEventListener('drop', function(event) {
            event.preventDefault(); // Evitar el comportamiento predeterminado del navegador
            dragArea.classList.remove('dragging'); // Quitar clase "dragging" al soltar el archivo

            // Obtener el archivo que se soltó
            const file = event.dataTransfer.files[0];

            if (file) { // Verificar si se soltó un archivo
                // Obtener el nombre del archivo
                const fileName = file.name;
                // Obtener el tamaño del archivo en MB
                const fileSize = (file.size / (1024 * 1024)).toFixed(2); // Convertir a MB con dos decimales

                // Crear el contenido HTML para mostrar la información del archivo
                const fileInfoHTML = `
                    <div class='nameFile'>${fileName}</div>
                    <div>${fileSize} MB</div>
                    <progress id="progressBarDrop" max="100" value="0"></progress> 
                    <span id="progressValue">0%</span>
                `;
                // Asignar el contenido HTML al div de información del archivo
                fileInfoDiv.innerHTML = fileInfoHTML;
                // Mostrar el div de información del archivo
                fileInfoDiv.style.display = 'block';

                // Llamar a la función de carga de archivos con la información relevante del archivo
                uploadFileDrag(file);
            } else {
                // Si no se seleccionó ningún archivo, limpiar el contenido del div
                fileInfoDiv.innerHTML = '';
                // Ocultar el div de información del archivo
                fileInfoDiv.style.display = 'none';
            }
        });

        // Escuchar el evento de dejar de arrastrar fuera del área
        dragArea.addEventListener('dragleave', function(event) {
            event.preventDefault(); // Evitar el comportamiento predeterminado del navegador
            dragArea.classList.remove('dragging'); // Quitar clase "dragging" al dejar de arrastrar fuera del área
        });
    </script>

    <!-- Manejo de subida del fichero de: Drag and Drop -->
    <script>
        localStorage.removeItem('chunkIndex');

        async function uploadFileDrag(file) {
            // Verificar si hay archivos soltados
            if (file) {
                const url = 'http://localhost:8899/upload.php';
                const chunkSize = 1024 * 1024; // 1MB

                let chunkIndex = localStorage.getItem('chunkIndex') || 0;
                chunkIndex = parseInt(chunkIndex);
                let start = chunkIndex * chunkSize;
                let end = Math.min(start + chunkSize, file.size);
                const totalChunks = Math.ceil(file.size / chunkSize);

                let uploadSuccess = false;

                while (start < file.size) {
                    const chunk = file.slice(start, end);
                    const formData = new FormData();
                    formData.append('file_bg_pic', chunk, file.name + '.part' + chunkIndex);

                    // Si este es el último fragmento, marcarlo como tal
                    if (chunkIndex === totalChunks - 1) {
                        formData.append('lastChunk', 'true');
                    }

                    try {
                        const response = await postFormData(url, formData);
                        console.log(response); // Response from server

                        // Mostrar el progreso y el mensaje de estado
                        const progress = Math.round(((chunkIndex + 1) / totalChunks) * 100);
                        const progressValue = document.getElementById('progressValue');
                        document.getElementById('progressBarDrop').value = progress;
                        progressValue.textContent = progress + '%';
                        document.getElementById('status').innerText = response.message;

                        if (response.success && chunkIndex === totalChunks - 1) {
                            document.getElementById('status').innerText = response.message;
                            uploadSuccess = true;
                            localStorage.removeItem('chunkIndex');
                            localStorage.removeItem('start');
                            break;
                        }

                        start = end;
                        end = Math.min(start + chunkSize, file.size);
                        chunkIndex++;

                    } catch (error) {
                        console.log(error);
                        // Mostrar errores en la interfaz de usuario
                        document.getElementById('status').innerText = 'Error: ' + error.message;
                        break; // Detener la subida en caso de error
                    }

                    // Guardar el índice del fragmento en la memoria del navegador
                    localStorage.setItem('chunkIndex', chunkIndex);
                    // Guardar el tamaño en bytes
                    localStorage.setItem('start', start);
                }

                // Dentro de la función uploadFileDrag
                if (!uploadSuccess) {
                    document.getElementById('status').innerText = 'Cargando...';
                    setTimeout(() => {
                        // Llamar a la función de carga de archivos con el archivo nuevamente
                        uploadFileDrag(file);
                    }, 500); // Intentar nuevamente después de 0,5 segundos
                }
            } else {
                // No hay archivos soltados, mostrar un mensaje de error
                document.getElementById('status').innerText = 'Error: No se ha soltado ningún archivo.';
            }
        }

        async function postFormData(url, formData) {
            const response = await fetch(url, {
                method: 'POST',
                body: formData
            });
            return await response.json();
        }
    </script>

    <!-- Manejo de subida del fichero de: Button uploader -->
    <script>
        localStorage.removeItem('chunkIndex');
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput2');
            const file = fileInput.files[0];
            const url = 'http://localhost:8899/upload.php';
            const chunkSize = 1024 * 1024; // 1MB

            let chunkIndex = localStorage.getItem('chunkIndex') || 0;
            chunkIndex = parseInt(chunkIndex);
            let start = chunkIndex * chunkSize;
            let end = Math.min(start + chunkSize, file.size);
            const totalChunks = Math.ceil(file.size / chunkSize);

            // Desactivar el botón de carga durante la subida
            // document.getElementById('uploadButton').disabled = true;
            document.getElementById('uploadButton').classList.add('disabled');

            let uploadSuccess = false;

            while (start < file.size) {
                const chunk = file.slice(start, end);
                const formData = new FormData();
                formData.append('file_bg_pic', chunk, file.name + '.part' + chunkIndex);

                // Si este es el último fragmento, marcarlo como tal
                if (chunkIndex === totalChunks - 1) {
                    formData.append('lastChunk', 'true');
                }

                try {
                    const response = await postFormData(url, formData);
                    console.log(response); // Response from server

                    // Mostrar el progreso y el mensaje de estado
                    // const progress = ((chunkIndex + 1) / totalChunks) * 100;
                    const progress = Math.round(((chunkIndex + 1) / totalChunks) * 100);
                    const progressValue = document.getElementById('progressValue');
                    document.getElementById('progressBar').value = progress;
                    progressValue.textContent = progress + '%';
                    document.getElementById('status').innerText = response.message;

                    if (response.success && chunkIndex === totalChunks - 1) {
                        document.getElementById('status').innerText = response.message;
                        uploadSuccess = true;
                        localStorage.removeItem('chunkIndex');
                        localStorage.removeItem('start'); 
                        document.getElementById('uploadButton').disabled = true;
                        break;
                    }

                    start = end;
                    end = Math.min(start + chunkSize, file.size);
                    chunkIndex++;

                } catch (error) {
                    console.log(error);
                    // Mostrar errores en la interfaz de usuario
                    document.getElementById('status').innerText = 'Error: ' + error.message;
                    break; // Detener la subida en caso de error
                }

                // Guardar el índice del fragmento en la memoria del navegador
                localStorage.setItem('chunkIndex', chunkIndex);
                // Guardar el tamaño en bytes
                localStorage.setItem('start', start);
            }

            // Si la carga no fue exitosa, intentar nuevamente después de un tiempo
            if (!uploadSuccess) {
                document.getElementById('status').innerText = 'Cargando...'; // Intentando nuevamente
                setTimeout(uploadFile, 500); // Intentar nuevamente después de 0,5 segundos
            }

            // Habilitar el botón de carga después de completar la subida
            document.getElementById('uploadButton').disabled = false;
        }

        async function postFormData(url, formData) {
            const response = await fetch(url, {
                method: 'POST',
                body: formData
            });
            return await response.json();
        }
    </script>
</body>
</html>
